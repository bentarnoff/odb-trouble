
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.2, mkdocs-material-1.4.1">
    
    
      
        <title>Techniques - ON-DEMAND SERVICES TROUBLESHOOTING GUIDE</title>
      
    
    
      <script src="../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-76741b64bc.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-66fa0d9bba.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../css/highlight-fix.css">
    
      <link rel="stylesheet" href="../css/solarized_dark.css">
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="teal" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href=".." title="ON-DEMAND SERVICES TROUBLESHOOTING GUIDE" class="md-logo md-header-nav__button">
            <img src="../images/pivotal-logo.png" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Techniques
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/kdudala1/odb-trouble" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      kdudala1/odb-trouble
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../images/pivotal-logo.png">
      </i>
    
    ON-DEMAND SERVICES TROUBLESHOOTING GUIDE
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/kdudala1/odb-trouble" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      kdudala1/odb-trouble
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../components/" title="Components" class="md-nav__link">
      Components
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../errors/" title="Errors" class="md-nav__link">
      Errors
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Techniques
      </label>
    
    <a href="./" title="Techniques" class="md-nav__link md-nav__link--active">
      Techniques
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-bosh-and-cf-to-access-logs-and-ssh" title="Using BOSH and CF to access logs and SSH" class="md-nav__link">
    Using BOSH and CF to access logs and SSH
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accessing-broker-logs-and-vms" title="Accessing broker logs and VM(s)" class="md-nav__link">
    Accessing broker logs and VM(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-service-instance-manifests-logs-and-vms" title="Accessing service instance manifests logs and VM(s)" class="md-nav__link">
    Accessing service instance manifests logs and VM(s)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mapping-a-cf-service-to-a-bosh-deployment" title="Mapping a cf service to a bosh deployment" class="md-nav__link">
    Mapping a cf service to a bosh deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-the-admin-credentials-for-a-service-instance" title="Getting the admin credentials for a service instance" class="md-nav__link">
    Getting the admin credentials for a service instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parsing-a-cf-error-message" title="Parsing a CF error message" class="md-nav__link">
    Parsing a CF error message
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-service-broker-errands" title="Running Service Broker Errands" class="md-nav__link">
    Running Service Broker Errands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register-broker" title="Register Broker" class="md-nav__link">
    Register Broker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deregister-broker" title="Deregister Broker" class="md-nav__link">
    Deregister Broker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-all-service-instances" title="Upgrade All Service Instances" class="md-nav__link">
    Upgrade All Service Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-orphaned-bosh-deployments" title="Detect Orphaned BOSH Deployments" class="md-nav__link">
    Detect Orphaned BOSH Deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-all-service-instances" title="Delete All Service Instances" class="md-nav__link">
    Delete All Service Instances
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#viewing-resource-saturation-and-scaling-resources" title="Viewing resource saturation and scaling resources" class="md-nav__link">
    Viewing resource saturation and scaling resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-the-owner-of-a-service-instance" title="Identifying the owner of a service instance" class="md-nav__link">
    Identifying the owner of a service instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-quota-saturation-and-number-of-service-instances" title="Monitoring quota saturation and number of service instances" class="md-nav__link">
    Monitoring quota saturation and number of service instances
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filing-a-support-ticket" title="Filing a support ticket" class="md-nav__link">
    Filing a support ticket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knowledge-base-community" title="Knowledge Base (Community)" class="md-nav__link">
    Knowledge Base (Community)
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-bosh-and-cf-to-access-logs-and-ssh" title="Using BOSH and CF to access logs and SSH" class="md-nav__link">
    Using BOSH and CF to access logs and SSH
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accessing-broker-logs-and-vms" title="Accessing broker logs and VM(s)" class="md-nav__link">
    Accessing broker logs and VM(s)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-service-instance-manifests-logs-and-vms" title="Accessing service instance manifests logs and VM(s)" class="md-nav__link">
    Accessing service instance manifests logs and VM(s)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mapping-a-cf-service-to-a-bosh-deployment" title="Mapping a cf service to a bosh deployment" class="md-nav__link">
    Mapping a cf service to a bosh deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-the-admin-credentials-for-a-service-instance" title="Getting the admin credentials for a service instance" class="md-nav__link">
    Getting the admin credentials for a service instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parsing-a-cf-error-message" title="Parsing a CF error message" class="md-nav__link">
    Parsing a CF error message
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-service-broker-errands" title="Running Service Broker Errands" class="md-nav__link">
    Running Service Broker Errands
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register-broker" title="Register Broker" class="md-nav__link">
    Register Broker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deregister-broker" title="Deregister Broker" class="md-nav__link">
    Deregister Broker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrade-all-service-instances" title="Upgrade All Service Instances" class="md-nav__link">
    Upgrade All Service Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detect-orphaned-bosh-deployments" title="Detect Orphaned BOSH Deployments" class="md-nav__link">
    Detect Orphaned BOSH Deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delete-all-service-instances" title="Delete All Service Instances" class="md-nav__link">
    Delete All Service Instances
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#viewing-resource-saturation-and-scaling-resources" title="Viewing resource saturation and scaling resources" class="md-nav__link">
    Viewing resource saturation and scaling resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#identifying-the-owner-of-a-service-instance" title="Identifying the owner of a service instance" class="md-nav__link">
    Identifying the owner of a service instance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-quota-saturation-and-number-of-service-instances" title="Monitoring quota saturation and number of service instances" class="md-nav__link">
    Monitoring quota saturation and number of service instances
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filing-a-support-ticket" title="Filing a support ticket" class="md-nav__link">
    Filing a support ticket
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#knowledge-base-community" title="Knowledge Base (Community)" class="md-nav__link">
    Knowledge Base (Community)
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/kdudala1/odb-trouble/edit/master/docs/techniques.md" title="Edit this page" class="md-icon md-content__icon">edit</a>
                
                
                <h1 id="techniques">Techniques<a class="headerlink" href="#techniques" title="Permanent link">&para;</a></h1>
<h2 id="using-bosh-and-cf-to-access-logs-and-ssh">Using BOSH and CF to access logs and SSH<a class="headerlink" href="#using-bosh-and-cf-to-access-logs-and-ssh" title="Permanent link">&para;</a></h2>
<ol>
<li>Follow the steps described here to <a href="https://docs.pivotal.io/pivotalcf/1-9/customizing/trouble-advanced.html#prepare">target your BOSH CLI</a> and <a href="https://docs.cloudfoundry.org/cf-cli/getting-started.html">log-in to your CF CLI</a></li>
</ol>
<h3 id="accessing-broker-logs-and-vms">Accessing broker logs and VM(s)<a class="headerlink" href="#accessing-broker-logs-and-vms" title="Permanent link">&para;</a></h3>
<ol>
<li>Identify the ODB deployment using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh deployments
</pre></div>
</td></tr></table></li>
<li>Download the ODB manifest using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh download manifest &lt;odb-deployment-name&gt; odb.yml
</pre></div>
</td></tr></table></li>
<li>Select the ODB deployment using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh deployment odb.yml
</pre></div>
</td></tr></table></li>
<li>View VMs in the deployment using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh instances
</pre></div>
</td></tr></table></li>
<li>To ssh onto the VM use 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh ssh &lt;instance-id&gt;
</pre></div>
</td></tr></table></li>
<li>Download broker logs by using the 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh logs &lt;instance-id&gt;
</pre></div>
</td></tr></table>
You can also <a href="https://docs.pivotal.io/pivotalcf/1-9/customizing/troubleshooting.html#component_logs">access logs via Ops Manager</a> by clicking on the "logs" tab in the tile and downloading the broker logs.</li>
</ol>
<p>The archive generated by BOSH or Ops Manager will comprise the following logs:</p>
<table>
<thead>
<tr>
<th><strong>Log Name</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>broker_ctl.log</td>
<td>The log for the control script for starting and stopping the on demand broker</td>
</tr>
<tr>
<td><strong>broker.log</strong></td>
<td>The log for requests to the on demand broker and the actions the broker performs while orchestrating the request (e.g. generating a manifest and calling BOSH). You will want to start here when troubleshooting</td>
</tr>
<tr>
<td>post-start.stderr.log</td>
<td>The log for any errors that occur during post-start verification</td>
</tr>
<tr>
<td>post-start.stdout.log</td>
<td>The log for post-start verification</td>
</tr>
</tbody>
</table>
<h3 id="accessing-service-instance-manifests-logs-and-vms">Accessing service instance manifests logs and VM(s)<a class="headerlink" href="#accessing-service-instance-manifests-logs-and-vms" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>To target an individual service instance deployment, retrieve the 
the guid of your service instance with the CF CLI command 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf service <span class="o">{</span>YOUR_SERVICE<span class="o">}</span> --guid
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Pre-pend the text <code class="codehilite">service_instance-</code> to the guid you just obtained to create the ID that BOSH uses for your service instance (e.g. if your guid is <code class="codehilite">1Hy6H</code>, this becomes <code class="codehilite">service_instance-1Hy6H</code>).</p>
</li>
<li>
<p>Download your bosh manifest for the service using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh download manifest service_instance-guid myservice.yml
</pre></div>
</td></tr></table></p>
</li>
<li>Select the deployment using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh deployment myservice.yml
</pre></div>
</td></tr></table></li>
<li>View VMs in the deployment using 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh instances
</pre></div>
</td></tr></table></li>
<li>Download instance logs by using the 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh logs &lt;instance-id&gt;
</pre></div>
</td></tr></table></li>
<li>To ssh onto the VM use 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh ssh &lt;instance-id&gt;
</pre></div>
</td></tr></table></li>
</ol>
<h2 id="mapping-a-cf-service-to-a-bosh-deployment">Mapping a <code class="codehilite">cf service</code> to a <code class="codehilite">bosh deployment</code><a class="headerlink" href="#mapping-a-cf-service-to-a-bosh-deployment" title="Permanent link">&para;</a></h2>
<ol>
<li>Retrieve the the guid of your service instance with the CF CLI command
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf service <span class="o">{</span>YOUR_SERVICE<span class="o">}</span> --guid
</pre></div>
</td></tr></table></li>
<li>
<p>Pre-pend the text <code class="codehilite">service_instance-</code> to the guid you just obtained to create the ID that BOSH uses for your service instance (e.g. if your guid is <code class="codehilite">1Hy6H</code>, this becomes <code class="codehilite">service_instance-1Hy6H</code>).</p>
</li>
<li>
<p>Download your bosh manifest for the service using
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh download manifest <span class="o">{</span>your_service_instance-guid<span class="o">}</span> myservice.yml
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Select the deployment using
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ bosh deployment myservice.yml
</pre></div>
</td></tr></table></p>
</li>
</ol>
<h2 id="getting-the-admin-credentials-for-a-service-instance">Getting the admin credentials for a service instance<a class="headerlink" href="#getting-the-admin-credentials-for-a-service-instance" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="../techniques/mapping-a-cf-service-to-a-bosh-deployment">Identify the service deployment by GUID</a>.</li>
<li><a href="https://docs.pivotal.io/pivotalcf/1-9/customizing/trouble-advanced.html#prepare">Login to BOSH</a></li>
<li><a href="../accessing-service-instance-manifests-logs-and-vms">Download the manifest for the service instance</a> and <a href="../components/missing-bosh-director-uuid">add the guid</a> if using the v1 BOSH CLI</li>
<li>Look in the manifest for the credentials as described in the service documentation.</li>
</ol>
<h2 id="parsing-a-cf-error-message">Parsing a CF error message<a class="headerlink" href="#parsing-a-cf-error-message" title="Permanent link">&para;</a></h2>
<p>Failed operations (create, update, bind, unbind, delete) will result in an error message that can be retrieved using the CF cli</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf service myservice

Service instance: myservice
Service: super-db
Bound apps:
Tags:
Plan: dedicated-vm
Description: Dedicated Instance
Documentation url:
Dashboard: 

Last Operation
Status: create failed
<span class="hll">Message: Instance provisioning failed: There was a problem completing your request. 
</span><span class="hll">         Please contact your operations team providing the following information: 
</span><span class="hll">         service: redis-acceptance, 
</span><span class="hll">         service-instance-guid: ae9e232c-0bd5-4684-af27-1b08b0c70089,
</span><span class="hll">         broker-request-id: 63da3a35-24aa-4183-aec6-db8294506bac, 
</span><span class="hll">         task-id: <span class="m">442</span>, 
</span><span class="hll">         operation: create
</span>Started: <span class="m">2017</span>-03-13T10:16:55Z
Updated: <span class="m">2017</span>-03-13T10:17:58Z
</pre></div>
</td></tr></table>
The information under the "Message" field can be used to debug further. Please provide this information to Pivotal Support when filing a ticket.</p>
<p>The <code class="codehilite">task-id</code> field maps to the BOSH task id. For further information on a failed BOSH task, use the <code class="codehilite">bosh task &lt;task-id&gt;</code> command in the BOSH CLI.</p>
<p>The <code class="codehilite">broker-request-guid</code> maps to the portion of the On-Demand Broker log containing the failed step. Access the broker log via your syslog aggregator, or access bosh logs for the broker by typing <code class="codehilite">bosh logs broker 0</code>. If you have more than one broker instance, you will need to repeat this process for each instance.</p>
<h2 id="running-service-broker-errands">Running Service Broker Errands<a class="headerlink" href="#running-service-broker-errands" title="Permanent link">&para;</a></h2>
<h3 id="register-broker">Register Broker<a class="headerlink" href="#register-broker" title="Permanent link">&para;</a></h3>
<p>This errand registers the broker with Cloud Foundry and enables access to plans in the service catalog. The errand should be run whenever the broker is re-deployed with new catalog metadata to update the Cloud Foundry catalog.</p>
<p>Plans with disabled service access will not be visible to non-admin Cloud Foundry users (including Org Managers and Space Managers). Admin Cloud Foundry users can see all plans including those with disabled service access.</p>
<p>The errand will do the following operaitons:</p>
<ul>
<li>Register the service broker with Cloud Controller</li>
<li>Enable service access for any plans that have the radio button set to <code class="codehilite">enabled</code> in the tile plan page.</li>
<li>Disable service access for any plans that have the radio button set to <code class="codehilite">disabled</code> in the tile plan page.</li>
<li>Do nothing for any for any plans that have the radio button set to <code class="codehilite">manual</code></li>
</ul>
<p>To run this errand use the following BOSH command against the on-demand service broker deployment:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bosh run errand register-broker
</pre></div>
</td></tr></table>

<h3 id="deregister-broker">Deregister Broker<a class="headerlink" href="#deregister-broker" title="Permanent link">&para;</a></h3>
<p>This errand deregisters a broker from Cloud Foundry. It requires that there are no existing service instances. You can use the <a href="#delete-all-service-instances">Delete All Service Instances errand</a> to delete any existing service instances that are problematic.</p>
<p>The errand will do the following operaitons:</p>
<ul>
<li>Delete the service broker from Cloud Controller</li>
<li>Fail if there are any service instances, with or without bindings</li>
</ul>
<p>To run this errand use the following BOSH command against the on-demand service broker deployment:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bosh run errand deregister-broker
</pre></div>
</td></tr></table>

<h3 id="upgrade-all-service-instances">Upgrade All Service Instances<a class="headerlink" href="#upgrade-all-service-instances" title="Permanent link">&para;</a></h3>
<p>If you have made changes to the plan defintion or uploaded a new tile into OpsManager you may want to upgrade all the services to the latest software / plan definition. </p>
<p>To do this you can either select the errand through the OpsManager UI and have this happen along with the <code class="codehilite">apply-changes</code> action or run the errand directly.</p>
<p>The errand will do the following operaitons:</p>
<ul>
<li>Collect all of the service instances the on-demand broker has registered</li>
<li>For each instance the errand will serially:<ul>
<li>Issue an upgrade command to the on-demand broker </li>
<li>The on-demand broker will re-generate the service instance manifest based on its latest configuration from the tile.</li>
<li>The on-demand broker will deploy the new mainfest for the service instance.</li>
<li>The errand will wait for this operation to complete, then proceed to the next instance.</li>
</ul>
</li>
<li>Any instances that have ongoing BOSH tasks at the time of upgrade will be added to a retry list.</li>
<li>Any instances in the retry list will be retried at the end of the errand until all are upgraded.</li>
<li>If any instance fails to upgrade the errand will fail immediately.<ul>
<li>This prevents any systemic problem from spreading to the rest of your service instances. </li>
</ul>
</li>
</ul>
<h3 id="detect-orphaned-bosh-deployments">Detect Orphaned BOSH Deployments<a class="headerlink" href="#detect-orphaned-bosh-deployments" title="Permanent link">&para;</a></h3>
<p>The deployment for a service instance is defined as ‘Orphaned’ when the BOSH deployment is still running, but the service is no longer registered in Cloud Foundry.</p>
<p>The orphan-deployments errand will collate a list of service deployments that have no matching service instances in Cloud Foundry and return the list to the operator. It is then up to the operator to remove the orphaned bosh deployments.</p>
<p>To run this errand use the following BOSH command against the on-demand service broker deployment:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bosh run errand orphan-deployments
</pre></div>
</td></tr></table>

<p>If orphan deployments are present, the errand will output a list of deployment names:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">[stdout]</span>
<span class="k">[{&quot;deployment_name&quot;:&quot;service-instance_aoeu39fgn-8125-05h2-9023-9vbxf7676f3&quot;}]</span>

<span class="k">[stderr]</span>
<span class="na">None</span>

<span class="na">Errand &#39;orphan-deployments&#39; completed successfully (exit code 0)</span>
</pre></div>
</td></tr></table>

<p>To cleanup orphaned instances you can perform the following actions:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Deleting the bosh deployment will destroy the vm, any data present will be lost.</p>
</div>
<p>To delete the orphan deployment run the following BOSH command:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bosh delete deployment service-instance_$GUID
</pre></div>
</td></tr></table></p>
<h3 id="delete-all-service-instances">Delete All Service Instances<a class="headerlink" href="#delete-all-service-instances" title="Permanent link">&para;</a></h3>
<p>This errand deletes all service instances of your broker’s service offering in every org and space of Cloud Foundry. It uses the Cloud Controller API to do this, and therefore only deletes instances the Cloud Controller knows about. It will not delete orphan BOSH deployments: those that don’t correspond to a known service instance. Orphan BOSH deployments should never happen, but in practice they might. Use the orphan-deployments errand to identify them.</p>
<p>The errand will do the following operaitons:</p>
<ul>
<li>Unbind all applications from the service instances</li>
<li>Delete all service instances sequentially</li>
<li>Check if any instances have been created while the errand was running</li>
<li>If instances are detected the errand will fail </li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This errand should only be used with extreme caution when you want to totally destroy all of the on-demand service instances in an environment.</p>
</div>
<p>To run this errand use the following BOSH command against the on-demand service broker deployment:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>bosh run errand delete-all-service-instances
</pre></div>
</td></tr></table>

<h2 id="viewing-resource-saturation-and-scaling-resources">Viewing resource saturation and scaling resources<a class="headerlink" href="#viewing-resource-saturation-and-scaling-resources" title="Permanent link">&para;</a></h2>
<p>Once a deployment has been selected, you can use the <code class="codehilite">bosh vms --vitals</code> or the <code class="codehilite">bosh instances --vitals</code> commands to view current resource utilization. You can also view process level information by using <code class="codehilite">bosh instances --ps</code>.</p>
<h2 id="identifying-the-owner-of-a-service-instance">Identifying the owner of a service instance<a class="headerlink" href="#identifying-the-owner-of-a-service-instance" title="Permanent link">&para;</a></h2>
<p>If you have spotted a failing deployment, you can identify which org/space owns this service instance, as well as retrieve a list of apps bound to it by following the steps below: </p>
<ol>
<li><code class="codehilite">bosh vms $deployment</code> shows a vm in failing state</li>
<li>Take the deployment name and strip the <code class="codehilite">service-instance_</code> leaving you with a <code class="codehilite">guid</code></li>
<li>Login to CF using a CF Admin user</li>
<li>Run 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf curl /v2/service_instances/:guid <span class="p">|</span> grep <span class="s2">&quot;space_url&quot;</span>
<span class="s2">&quot;space_url&quot;</span>: <span class="s2">&quot;/v2/spaces/</span><span class="nv">$space_guid</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table></li>
<li>
<p>Take the space url and run 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf curl /v2/spaces/<span class="nv">$space_guid</span> <span class="p">|</span> grep -E <span class="s2">&quot;name|organization_url&quot;</span>
<span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;myspace&quot;</span>,
<span class="s2">&quot;organization_url&quot;</span>: <span class="s2">&quot;/v2/organizations/</span><span class="nv">$org_guid</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Take the organization_url and run 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cf curl /v2/organizations/$org_guid | grep “name”
&quot;name&quot;: &quot;myorg&quot;
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Combine the output of the names to give you the org and space of the service instance. 
From here run:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cf target -o $org -s $space
</pre></div>
</td></tr></table></p>
</li>
<li><code class="codehilite">cf services</code> shows you all the services and bound apps</li>
<li>To find who is the space manger run:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cf curl /v2/spaces/$space_guid/managers
</pre></div>
</td></tr></table></li>
<li>Use this information to contact the manager if needed </li>
</ol>
<h2 id="monitoring-quota-saturation-and-number-of-service-instances">Monitoring quota saturation and number of service instances<a class="headerlink" href="#monitoring-quota-saturation-and-number-of-service-instances" title="Permanent link">&para;</a></h2>
<p>Quota saturation and total number of service instances are available via ODB metrics emitted to loggregator. The metric names are shown below:</p>
<table>
<thead>
<tr>
<th><strong>Metric Name</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite">on-demand-broker/{service-name-marketplace}/quota_remaining</code></td>
<td>global quota remaining for all instances across all plans</td>
</tr>
<tr>
<td><code class="codehilite">on-demand-broker/{service-name-marketplace}/{plan_name}/quota_remaining</code></td>
<td>quota remaining for a particular plan</td>
</tr>
<tr>
<td><code class="codehilite">on-demand-broker/{service-name-marketplace}/total_instances</code></td>
<td>total instances created across all plans</td>
</tr>
<tr>
<td><code class="codehilite">on-demand-broker/{service-name-marketplace}/{plan_name}/total_instances</code></td>
<td>total instances created for a given plan</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Quota metrics are not emitted if no quota has been set.</p>
</div>
<h2 id="filing-a-support-ticket">Filing a support ticket<a class="headerlink" href="#filing-a-support-ticket" title="Permanent link">&para;</a></h2>
<p>You can file a support ticket <a href="https://support.pivotal.io/">here</a>. Please be sure to provide the <a href="../techniques/#parsing-a-cf-error-message">error message</a> from 
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ cf service &lt;your-service&gt;
</pre></div>
</td></tr></table>
Please also provide your <a href="../techniques/#accessing-broker-logs-and-vms">service broker logs</a>, your <a href="../techniques/#accessing-service-instance-logs-and-vms">service instance logs</a> and <a href="../techniques/#parsing-a-cf-error-message">BOSH task output</a> (if a <code class="codehilite">task-id</code> is provided as part of the <code class="codehilite">cf service &lt;your-service&gt;</code> output) to help expedite troubleshooting.</p>
<h2 id="knowledge-base-community">Knowledge Base (Community)<a class="headerlink" href="#knowledge-base-community" title="Permanent link">&para;</a></h2>
<p>Imagine a world where we autopopulate the first 10 hits from <a href="http://discuss.pivotal.io">http://discuss.pivotal.io</a> . For now, you'll just have to click on the link.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../errors/" title="Errors" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Errors
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-3964c0cb56.js"></script>
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>